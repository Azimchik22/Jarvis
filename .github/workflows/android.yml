name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build APK (Docker + accept SDK licenses)
        run: |
          docker run --rm \
            --entrypoint /bin/bash \
            -v "$PWD":/home/user/app \
            -w /home/user/app \
            kivy/buildozer:latest \
            -lc "
              set -e

              # убрать интерактивный вопрос про root
              sed -i 's/^warn_on_root *=.*/warn_on_root = 0/' buildozer.spec || true

              # поставить curl/unzip если вдруг нет
              (command -v curl >/dev/null 2>&1) || (apt-get update && apt-get install -y curl)
              (command -v unzip >/dev/null 2>&1) || (apt-get update && apt-get install -y unzip)

              export ANDROID_SDK_ROOT=/root/.buildozer/android/platform/android-sdk
              export ANDROID_HOME=\$ANDROID_SDK_ROOT
              mkdir -p \$ANDROID_SDK_ROOT/cmdline-tools

              # поставить sdkmanager (cmdline-tools), если его нет
              if [ ! -f \$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager ]; then
                cd /tmp
                curl -L -o cmdline.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
                unzip -q cmdline.zip -d \$ANDROID_SDK_ROOT/cmdline-tools-tmp
                mkdir -p \$ANDROID_SDK_ROOT/cmdline-tools/latest
                mv \$ANDROID_SDK_ROOT/cmdline-tools-tmp/cmdline-tools/* \$ANDROID_SDK_ROOT/cmdline-tools/latest/
                rm -rf \$ANDROID_SDK_ROOT/cmdline-tools-tmp cmdline.zip
              fi

              export PATH=\$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:\$ANDROID_SDK_ROOT/platform-tools:\$PATH

              # принять лицензии + поставить build-tools (где есть aidl)
              yes | sdkmanager --licenses
              sdkmanager \"platform-tools\" \"platforms;android-34\" \"build-tools;36.0.0\" \"build-tools;36.1.0\"

              cd /home/user/app
              buildozer android debug
            "

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: JarvisAI-APK
          path: bin/*.apk
